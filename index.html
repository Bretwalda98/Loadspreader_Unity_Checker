<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Loadspreader Calculator</title>
<style>
  /* ===== Unified DARK THEME (matches other apps) ===== */
  :root{
    color-scheme: dark;
    --bg:#0b1220; --text:#e5e7eb; --muted:#94a3b8;
    --primary:#3b82f6; --primary-disabled:#1f3b70; --btn-text:#e5e7eb;
    --header-bg:#0f172a; --card:#0f172a; --card2:#0b152e;
    --border:#1f2a44; --line:#223056;
    --advert-bg:#17203a; --advert-border:#273759; --advert-text:#e5e7eb;
    --modal-bg:#0f172a; --danger:#ef4444; --good:#22c55e;
  }

  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg); color:var(--text); line-height:1.5;
  }
  .hide{display:none}
  .section-title{
    font-weight:600; margin:24px 0 8px; padding-bottom:6px;
    border-bottom:1px solid var(--border); font-size:.98rem; color:var(--muted);
  }
  .green{color:var(--good)} .red{color:var(--danger)}

  /* inputs — higher contrast (including dropdowns) */
  input,select{
    width:100%; font-size:1rem; border-radius:10px; padding:12px 12px;
    border:1px solid var(--border);
    background:linear-gradient(180deg, var(--card), var(--card2));
    color:var(--text);
    margin-top:6px; margin-bottom:14px;
    appearance:none;
  }
  select:focus, input:focus{
    outline:none; border-color:var(--primary);
    box-shadow:0 0 0 2px rgba(59,130,246,.35);
  }
  /* Force option panel colours across browsers */
  select option{
    background:var(--card);
    color:var(--text);
  }
  /* Firefox dropdown list */
  @-moz-document url-prefix(){
    select{ color:var(--text); background:var(--card); }
  }

  label{display:block; font-size:.9rem; color:var(--muted)}

  header{
    background:var(--header-bg); padding:14px 16px; display:flex; align-items:center; gap:12px;
    position:sticky; top:0; z-index:2; border-bottom:1px solid var(--border);
  }
  header h1{margin:0; font-size:1.1rem; flex:1; text-align:center; color:var(--text); letter-spacing:.2px}
  .help-kbd{
    border:1px solid var(--border); padding:2px 8px; border-radius:8px;
    background:rgba(255,255,255,.03); color:var(--text); cursor:pointer;
  }

  .container{padding:16px; max-width:min(1400px,96vw); margin:0 auto;}

  /* ===== Layout that scales ===== */
  .layout{display:grid; gap:20px}
  .left, .right{background:transparent}
  @media (min-width: 980px){
    .layout{grid-template-columns: 1fr 1fr; align-items:start}
  }

  #plot{
    width:100%; height:100%;
    border:1px solid var(--line); border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.15));
  }
  .canvas-wrap{width:100%; height:clamp(360px, 62vh, 820px)}

  .advert-bar{
    background:var(--advert-bg); color:var(--advert-text); padding:10px 12px; text-align:center; font-size:.9rem;
    border:1px solid var(--advert-border); border-radius:10px; margin-bottom:16px
  }
  .advert-bar a{color:inherit; text-decoration:none; font-weight:600}
  .responsive{width:100%; height:auto}
  .err{font-size:.82rem; margin-top:-10px; margin-bottom:10px; color:var(--danger)}
</style>
</head>
<body>

<div id="calc-screen">
  <header>
    <h1>Loadspreader Calculator</h1>
    <button id="help-btn" title="Help" class="help-kbd">Help</button>
  </header>

  <div class="container">
    <div class="advert-bar">
      <a href="#" target="_blank" rel="noopener">Advert here</a>
    </div>

    <div class="layout">
      <!-- LEFT: inputs & diagram -->
      <div class="left">
        <img id="diagram" src="LSP.png" class="responsive" alt="Loadspreader schematic diagram">

        <div class="section-title">Input Parameters</div>

        <label>Top Contact Type
          <select id="top_type">
            <option value="mat">Steel Mat</option>
            <option value="crawler">Crawler Tracks</option>
          </select>
        </label>

        <label id="label_Lw"><span class="label-text">Top Steel Mat Length L<sub>w</sub> (m)</span>
          <input id="Lw" type="number" step="0.01" value="2">
          <div id="err_Lw" class="err hide"></div>
        </label>
        <label id="label_Lr"><span class="label-text">Top Steel Mat Width L<sub>r</sub> (m)</span>
          <input id="Lr" type="number" step="0.01" value="1">
          <div id="err_Lr" class="err hide"></div>
        </label>

        <label id="label_qmax">Applied Outrigger Pressure q<sub>max</sub> (t/m²)
          <select id="q_max" onfocus="this.select()" >
            <!-- using select here improves visibility on some Android skins; JS treats it like input via value -->
            <option value="40">40</option>
            <option value="30">30</option>
            <option value="50">50</option>
            <option value="60">60</option>
          </select>
          <div id="err_qmax" class="err hide"></div>
        </label>
        <label id="label_Pmax" class="hide">Point Load Force P<sub>max</sub> (t)
          <input id="p_max" type="number" step="0.1" value="100">
        </label>
        <label id="label_Wmat" class="hide">Steel Mat Self-Weight W<sub>m</sub> (t)
          <input id="w_mat" type="number" step="0.1" value="0">
        </label>

        <label>Loadspreader Length L<sub>sl</sub> (m)
          <input id="Lsl" type="number" step="0.01" value="3">
        </label>
        <label>Loadspreader Width L<sub>sb</sub> (m)
          <input id="Lsb" type="number" step="0.01" value="1">
        </label>
        <label>Loadspreader Thickness h (m)
          <input id="Lsh" type="number" step="0.01" value="0.4">
        </label>
        <label>Number of Base Layers
          <input id="layers" type="number" step="1" value="1">
        </label>
        <label>Allowable Ground Pressure (t/m²)
          <input id="GBP_allow" type="number" step="0.1" value="20">
        </label>
        <label>Decimal Precision
          <input id="precision" type="number" step="1" value="2">
        </label>

        <div class="section-title">Material</div>
        <select id="material">
          <option value="Azobe">Azobe (timber)</option>
          <option value="S235">S235 (steel)</option>
          <option value="S355">S355 (steel)</option>
        </select>
      </div>

      <!-- RIGHT: results & canvas -->
      <div class="right">
        <div class="section-title">Results</div>
        <div id="results"></div>
        <div id="verdict" style="font-weight:600"></div>

        <div class="section-title">3-D View (schematic)</div>
        <div class="canvas-wrap"><canvas id="plot"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Help modal kept from previous rev ===== -->
<div id="help-modal" class="modal hide">
  <div class="modal-content">
    <button id="help-close" style="float:right;font-size:1.05rem;border:1px solid var(--border);background:transparent;color:var(--text);padding:2px 8px;border-radius:8px;cursor:pointer">✕</button>
    <h2>Loadspreader Calculator – Help Guide</h2>
    <p><strong>Version:</strong> 2025-07-13 (rev 37.2)</p>
    <h3>1) Purpose</h3>
    <p>Checks bending, shear, bearing stress of timber/steel load-spreaders and estimates ground bearing pressure (GBP). Suitable for outriggers, bogies, and crawler tracks.</p>
    <h3>2) Quick Workflow</h3>
    <ol>
      <li>Select <em>Steel Mat</em> (enter <strong>P<sub>max</sub></strong> and <strong>W<sub>m</sub></strong>) or <em>Crawler</em> (enter <strong>q<sub>max</sub></strong>).</li>
      <li>Set top footprint <strong>L<sub>w</sub></strong> (width) and <strong>L<sub>r</sub></strong> (length).</li>
      <li>Set base geometry <strong>L<sub>sl</sub></strong>, <strong>L<sub>sb</sub></strong>, thickness <strong>h</strong>, layers, and material.</li>
      <li>Results update live; failed checks are red.</li>
    </ol>
    <h3>3) Units</h3>
    <ul><li>Geometry m; P/W in t; pressures t/m²; stresses MPa (N/mm²).</li></ul>
    <h3>4) Outputs</h3>
    <ul>
      <li>σ<sub>B</sub> (bending), τ<sub>S</sub> (shear), σ<sub>C</sub> (bearing) in MPa; GBP in t/m²; Q<sub>S</sub> and q<sub>B</sub> for reference.</li>
    </ul>
    <h3>5) Material limits (MPa)</h3>
    <table>
      <tr><th>Material</th><th>σ<sub>max</sub></th><th>τ<sub>max</sub></th><th>σ<sub>c,max</sub></th></tr>
      <tr><td>Azobe</td><td>25</td><td>2</td><td>8</td></tr>
      <tr><td>S235</td><td>235</td><td>135.7</td><td>≈319</td></tr>
      <tr><td>S355</td><td>355</td><td>205</td><td>≈480</td></tr>
    </table>
    <h3>6) Assumptions</h3>
    <ol>
      <li>Compliant support enabling redistribution; full contact (no voids).</li>
      <li>Uniform/predictable pressure beneath footprint; layers act compositely.</li>
      <li>Serviceability deflection not checked; verify separately if needed.</li>
    </ol>
    <h3>7) Sanity checks</h3>
    <ul>
      <li>L<sub>w</sub> &lt; L<sub>sl</sub> (geometry check).</li>
      <li>GBP ≤ GBP<sub>allow</sub>.</li>
    </ul>
  </div>
</div>

<script>
/* ===== Materials (corrected values) ===== */
const materials={
  Azobe:{rho:1.05,  sigma_max:25,   tau_max:2,     sigma_c_max:8},
  S235: {rho:7.85,  sigma_max:235,  tau_max:135.7, sigma_c_max:319},
  S355: {rho:7.85,  sigma_max:355,  tau_max:205,   sigma_c_max:480}
};
const g=9.81, $=id=>document.getElementById(id);
const round=(v,p)=>(!isFinite(v)||isNaN(v))?v:Number(Math.round(`${v}e${p}`)+`e-${p}`);
const diagramSrc={mat:'LSP.png', crawler:'crawler.png'};

/* Label behaviour preserved */
function updateTopLabels(){
  $('label_Lw').querySelector('.label-text').innerHTML=
    $('top_type').value==='crawler' ? 'Crawler Track Length L<sub>r</sub> (m)' : 'Top Steel Mat Length L<sub>r</sub> (m)';
  $('label_Lr').querySelector('.label-text').innerHTML=
    $('top_type').value==='crawler' ? 'Crawler Track Width L<sub>w</sub> (m)'  : 'Top Steel Mat Width L<sub>w</sub> (m)';
  const isMat=$('top_type').value==='mat';
  $('label_qmax').classList.toggle('hide',isMat);
  $('label_Pmax').classList.toggle('hide',!isMat);
  $('label_Wmat').classList.toggle('hide',!isMat);
  $('diagram').src=diagramSrc[$('top_type').value];
}
$('top_type').addEventListener('change',()=>{updateTopLabels(); runCalc();});
updateTopLabels();

/* Modal */
$('help-btn').onclick=()=>$('help-modal').classList.remove('hide');
$('help-close').onclick=()=>$('help-modal').classList.add('hide');
$('help-modal').addEventListener('click',e=>{ if(e.target.id==='help-modal')$('help-modal').classList.add('hide'); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape'&&!$('help-modal').classList.contains('hide'))$('help-modal').classList.add('hide'); });

/* Core solver (unchanged maths) */
function solve(p){
  const Qs=p.q_max*p.Lw*p.Lsb;
  const qb=Qs/p.Lsl;
  const Lb=(p.Lsl-p.Lw)/2;
  const Ab=p.Lsb*1000*p.Lsh*1000;
  const Sx=Ab*p.Lsh*1000/6;
  const Mx=0.5*qb*Lb*Lb*g*1e6;
  const sB= Mx/(p.layers*Sx);
  const tS= (qb*Lb*g*1e3)/(p.layers*Ab);
  const sC= p.q_max*g/1e3;
  const GBP= p.q_max*p.Lw/p.Lsl + p.material.rho*p.Lsh*p.layers;
  return {
    Qs:round(Qs,p.precision), qb:round(qb,p.precision), Lb:round(Lb,p.precision),
    sB:round(sB,p.precision), tS:round(tS,p.precision), sC:round(sC,p.precision),
    GBP:round(GBP,p.precision),
    passB:Math.abs(sB)<p.material.sigma_max,
    passS:Math.abs(tS)<p.material.tau_max,
    passC:sC<p.material.sigma_c_max,
    passGBP:GBP<p.GBP_allow
  };
}

/* Live calc + resize-aware re-render */
function runCalc(){
  const topType=$('top_type').value;
  ['err_Lw','err_Lr','err_qmax'].forEach(id=>$(id).classList.add('hide'));

  const p={
    /* keep your existing field mapping intact */
    Lw:+$('Lr').value, Lr:+$('Lw').value, Lsl:+$('Lsl').value, Lsb:+$('Lsb').value,
    Lsh:+$('Lsh').value, layers:+$('layers').value, GBP_allow:+$('GBP_allow').value,
    precision:+$('precision').value, material:materials[$('material').value]
  };

  let totalLoad=0;
  if(topType==='mat'){
    p.p_max=+$('p_max').value; p.w_mat=+$('w_mat').value;
    if(!(p.p_max>0)){showErr('err_qmax','Enter a valid Pmax (>0).'); return;}
    if(!(p.w_mat>=0)){showErr('err_qmax','Enter a valid self-weight (≥0).'); return;}
    totalLoad=p.p_max+p.w_mat;
    p.q_max=totalLoad/(p.Lr*p.Lw);
    // Reflect derived qmax in the dropdown
    syncQmaxDisplay(round(p.q_max,p.precision));
  }else{
    // Read from select (treat like input)
    p.q_max=+($('q_max').value || $('q_max').selectedOptions[0]?.value || 0);
    if(!(p.q_max>0)){showErr('err_qmax','Enter a valid qmax (>0).'); return;}
    totalLoad=p.q_max*p.Lr*p.Lw;
  }

  if(p.Lw>=p.Lsl){ showErr('err_Lw','Top-contact width (Lw) must be less than base length (Lsl).'); return; }

  const r=solve(p);
  const out=$('results'); out.innerHTML='';
  const heading=t=>{const d=document.createElement('div');d.textContent=t;d.style.fontWeight='600';d.style.marginTop='6px';out.appendChild(d);};
  const line=(lab,val,ok)=>{const d=document.createElement('div');d.textContent=`${lab}: ${val}`;if(ok!==undefined)d.className=ok?'green':'red';out.appendChild(d);};

  heading('=== Load Results ===');
  if(topType==='mat'){
    line('Point Load (Pmax) [ton]',round(p.p_max,p.precision));
    line('Mat Self-Weight (Wm) [ton]',round(p.w_mat,p.precision));
    line('Total Load (P+W) [ton]',round(totalLoad,p.precision));
  }
  line('Applied Pressure (qmax) [ton/m2]', topType==='mat' ? round(p.q_max,p.precision) : round(p.q_max,p.precision));
  line('Shear Force Top Contact (QS) [ton]',r.Qs);
  line('Shear per Metre (QB) [ton/m]',r.qb); out.appendChild(document.createElement('br'));

  heading('=== Stress Checks ===');
  line('Bending Stress (σB) [N/mm2]',r.sB,r.passB);
  line('Shear Stress (τS) [N/mm2]',r.tS,r.passS);
  line('Compression Stress (σC) [N/mm2]',r.sC,r.passC); out.appendChild(document.createElement('br'));

  heading('=== Ground Pressure ===');
  line('Ground Bearing Pressure (GBP) [ton/m2]',r.GBP,r.passGBP);

  $('verdict').textContent=r.passB&&r.passS&&r.passC&&r.passGBP?'✅ All checks passed':'❌ Fails – see red items';
  $('verdict').className=r.passB&&r.passS&&r.passC&&r.passGBP?'green':'red';

  render3D({...p,q_max:p.q_max});
}

function syncQmaxDisplay(val){
  const sel=$('q_max');
  // If derived value not in list, inject it as the first option so it shows correctly
  let opt=sel.querySelector('option[data-derived="1"]');
  if(!opt){ opt=document.createElement('option'); opt.setAttribute('data-derived','1'); sel.prepend(opt); }
  opt.value=String(val); opt.textContent=String(val);
  sel.value=String(val);
}

function showErr(id,msg){ const el=$(id); el.textContent=msg; el.classList.remove('hide'); }
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a),ms); }; }
const liveRun = debounce(runCalc, 120);

document.querySelectorAll('#calc-screen input, #calc-screen select').forEach(el=>{
  el.addEventListener('input', liveRun);
  el.addEventListener('change', liveRun);
});

window.addEventListener('resize', debounce(runCalc, 150));
runCalc();

/* Renderer unchanged, just reads canvas size */
function render3D(p){
  const c=$('plot'),ctx=c.getContext('2d');
  c.width=c.clientWidth; c.height=c.clientHeight;
  const w=c.width,h=c.height; ctx.clearRect(0,0,w,h);
  const nLen=Math.floor(p.Lw/p.Lsl)+1, nWid=Math.floor(p.Lr/p.Lsb)+1;
  const totalLen=nLen*p.Lsl, totalWid=nWid*p.Lsb;
  const sc=0.9*Math.min(
    w/((totalLen+totalWid)*Math.cos(Math.PI/6)*100),
    h/((totalLen+totalWid)*Math.sin(Math.PI/6)*100+p.layers*p.Lsh*100+p.Lsh*10)
  );
  const iso=(x,y,z)=>{ const xr=x*Math.cos(Math.PI/2)-y*Math.sin(Math.PI/2),
                             yr=x*Math.sin(Math.PI/2)+y*Math.cos(Math.PI/2),
                             ix=(xr-yr)*Math.cos(Math.PI/6),
                             iy=(xr+yr)*Math.sin(Math.PI/6)-z;
    return [w/2+ix*sc,h*0.6+iy*sc];
  };
  const poly=pts=>{ctx.beginPath();ctx.moveTo(...pts[0]);pts.slice(1).forEach(pt=>ctx.lineTo(...pt));ctx.closePath();ctx.fill();ctx.stroke();};
  const box=(x,y,z,dx,dy,dz,col,a)=>{
    ctx.fillStyle=col;ctx.globalAlpha=a;
    poly([iso(x,    y+dy,z),iso(x+dx,y+dy,z),iso(x+dx,y+dy,z+dz),iso(x,    y+dy,z+dz)]);
    poly([iso(x+dx,y,z),    iso(x+dx,y+dy,z),iso(x+dx,y+dy,z+dz),iso(x+dx,y,z+dz)]);
    poly([iso(x,y,z),       iso(x,y+dy,z),    iso(x,y+dy,z+dz),   iso(x,y,z+dz)]);
    poly([iso(x,y,z),       iso(x+dx,y,z),    iso(x+dx,y,z+dz),   iso(x,y,z+dz)]);
    poly([iso(x,y,z+dz),    iso(x+dx,y,z+dz), iso(x+dx,y+dy,z+dz),iso(x,y+dy,z+dz)]);
    ctx.globalAlpha=1;
  };
  for(let k=0;k<p.layers;k++){
    const z=k*p.Lsh*100;
    for(let i=0;i<nLen;i++){
      for(let j=0;j<nWid;j++){
        box((-totalLen/2+i*p.Lsl)*100,(-totalWid/2+j*p.Lsb)*100,z,p.Lsl*100,p.Lsb*100,p.Lsh*100,'#8B4513',0.7);
      }
    }
  }
  box(-p.Lw*50,-p.Lr*50,p.layers*p.Lsh*100,p.Lw*100,p.Lr*100,p.Lsh*10,'#707070',0.85);
}
</script>
</body>
</html>
